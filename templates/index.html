{% extends "base.html" %}
{% block title %}Plantlog - {{ t['Plant Tracker'] }}{% endblock %}

{% block content %}
<h1 class="mb-4">{{ t['My plants'] }}</h1>

{# Friendly, human-readable labels for each action -------------------- #}
{% set human_names = {
  'sow':       'Sowing started on',
  'soak':      'Soaking since',
  'strat':     'Stratification started on',
  'sprout':    'Germinated on',
  'flower':    'Flowering since',
  'fruit':     'Fruiting since',
  'dead':      'Died on',
  'measure':   'Measurement taken on'
} %}

{% if plants %}
  <div class="accordion" id="plants-acc">
    {% for p in plants %}
      {% set idx = p.id %}
      {% set current_event = p.current %}
      {% set action = current_event.action %}
      {% set event_spec = event_map[action] %}

      {# ---- Plant state --------------------------------------------- #}
      {% set state         = p.state %}
      {% set state_label   = state.label if state else '?' %}
      {% set state_icon    = state.icon_class if state else 'fa-question' %}
      {% set state_color   = state.color_class if state else 'text-muted' %}

      {# ---- Summary line ------------------------------------------- #}
      {% set now_date   = today %}
      {% set start_date = current_event.start %}
      {% set summary    = (human_names[action] in t and t[human_names[action]] or human_names[action]) ~ ' ' ~ start_date %}

      {# Extra badges / counters depending on the action -------------- #}
      {% if action == 'sow' and 'range' in current_event %}
        {% set min_val,current_unit,max_val,max_unit = current_event.range %}
        {% set min_days = duration_to_days(min_val, current_unit) %}
        {% set max_days = duration_to_days(max_val, max_unit) %}
        {% set min_date = start_date | dateadd(days=min_days) %}
        {% set max_date = start_date | dateadd(days=max_days) %}
        {% if now_date > max_date %}
          {% set summary = summary ~ ' <span class="badge bg-danger ms-2">' ~ t['Overdue'] ~ '</span>' %}
        {% elif now_date >= min_date %}
          {% set summary = summary ~ ' <span class="badge bg-warning text-dark ms-2">' ~ t['Anytime soon'] ~ '</span>' %}
        {% else %}
          {% set days_left = (min_date - now_date).days %}
          {% set summary = summary ~ ' <span class="badge bg-info text-dark ms-2">' ~ days_left|string ~ ' ' ~ t['days'] ~ ' ' ~ t['left'] ~ '</span>' %}
        {% endif %}
      {% elif action in ['soak','strat'] %}
        {% set val,unit = current_event.duration %}
        {% set duration_days = duration_to_days(val, unit) %}
        {% set end_date = start_date | dateadd(days=duration_days) %}
        {% if now_date >= end_date %}
          {% set summary = summary ~ ' <span class="badge bg-secondary ms-2">' ~ t['Done'] ~ '</span>' %}
        {% else %}
          {% set days_left = (end_date - now_date).days %}
          {% set summary = summary ~ ' <span class="badge bg-info text-dark ms-2">' ~ days_left|string ~ ' ' ~ t['days'] ~ ' ' ~ t['left'] ~ '</span>' %}
        {% endif %}
      {% elif action == 'sprout' %}
        {% set summary = summary ~ ' <span class="badge bg-success ms-2"><i class="fas fa-check"></i></span>' %}
      {% endif %}

      <div class="accordion-item">
        <h2 class="accordion-header" id="heading-{{ idx }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ idx }}">

            {# Mobile: icon only --------------------------------------- #}
            <span class="d-inline-flex d-sm-none align-items-center flex-shrink-0 me-2">
              <i class="fas {{ state_icon }} {{ state_color }} fa-lg"></i>
            </span>

            {# Desktop: icon + label, fixed width for alignment -------- #}
            <span class="d-none d-sm-inline-flex align-items-center flex-shrink-0 me-3" style="width: 10.5rem;">
              <i class="fas {{ state_icon }} {{ state_color }} fa-lg"></i>
              <span class="ms-2 small {{ state_color }} fw-semibold text-uppercase">{{ t[state_label] if state_label in t else state_label }}</span>
            </span>

            {# Main plant info ---------------------------------------- #}
            <div class="flex-grow-1">
              <div class="fw-semibold">
                {{ p.common }} <small class="text-muted fst-italic">({{ p.latin }})</small>
              </div>
              <div class="small text-muted">{{ summary|safe }}</div>
              {% if p.location %}
                <div class="small text-muted"><i class="fas fa-location-dot me-1"></i>{{ p.location }}</div>
              {% endif %}
              {% if p.notes %}
                <div class="small text-muted"><i class="fas fa-sticky-note me-1"></i>{{ p.notes }}</div>
              {% endif %}
            </div>
          </button>
        </h2>

        <div id="collapse-{{ idx }}" class="accordion-collapse collapse" data-bs-parent="#plants-acc">
          <div class="accordion-body">
            <ul class="timeline">
              {% for h in p.history|reverse %}
                {% set evspec = event_map[h.action] %}
                <li class="timeline-item">
                  <span class="timeline-icon {{ evspec.color_class }}"><i class="fas {{ evspec.icon }}"></i></span>
                  <div>
                    <strong>{{ t[human_names[h.action]] if human_names[h.action] in t else human_names[h.action] }}</strong> – {{ h.start }}
                    {% if h.action == 'sow' and 'range' in h %}
                      <div class="text-muted small">
                        {{ t['Expected sprout time'] }}: {{ h.range[0] }} {{ t[h.range[1]] }} – {{ h.range[2] }} {{ t[h.range[3]] }}
                      </div>
                    {% elif h.action == 'measure' %}
                      <div class="text-muted small">
                        {{ h.size[0] }} {{ h.size[1] }}
                      </div>
                    {% elif h.action in ['soak','strat'] %}
                      <div class="text-muted small">{{ h.duration[0] }} {{ t[h.duration[1]] }}</div>
                    {% elif h.action == 'sprout' %}
                      {% set sow = p.history|selectattr('action','equalto','sow')|list|last %}
                      {% if sow %}
                        {% set sprouted_date = h.start|todate %}
                        {% set sow_date = sow.start|todate %}
                        {% set germ_days = (sprouted_date - sow_date).days %}
                        <div class="text-muted small">
                          {{ t['Sprouted in'] }} {{ germ_days }} {{ t['days'] }}
                        </div>
                      {% endif %}
                    {% endif %}
                  </div>
                  <a href="{{ url_for('edit_stage', action_id=h.id, lang=lang) }}" class="text-secondary ms-2 align-top" title="{{ t['Edit stage'] }}">
                    <i class="fas fa-edit" style="font-size:0.9rem;"></i>
                  </a>
                </li>
              {% endfor %}
            </ul>

            <div class="d-flex gap-2 mt-3">
              <a href="{{ url_for('edit_plant', idx=idx, lang=lang) }}" class="btn btn-outline-secondary btn-sm">{{ t['Edit plant'] }}</a>
              <a href="{{ url_for('add_stage', idx=idx, lang=lang) }}" class="btn btn-outline-primary btn-sm">{{ t['Add stage'] }}</a>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p class="text-muted">{{ t['No plants yet'] }}</p>
{% endif %}
{% endblock %}